---
title: 测试用例结构化整理最佳实践
type: note
permalink: testing/测试用例结构化整理最佳实践
tags:
- testing
- refactoring
- best-practices
- structure
---

# 测试用例结构化整理最佳实践

## 概述

本文档总结了在light-expression项目中实施的测试用例结构化整理的最佳实践。主要目标是将原本集中在一个大测试类中的测试用例，按照源代码的包结构进行合理分布，提高代码可维护性和测试覆盖率。

## 核心原则

### 1. 测试与源代码包结构一致性
- 测试类的包结构应与被测试的源代码包结构保持一致
- 每个被测试的类或包应该有对应的测试类
- 遵循`src/test/java`下与`src/main/java`相同的包路径结构

### 2. 职责单一原则
- 每个测试类应专注于测试特定模块或功能
- 避免创建包含大量无关测试的大测试类
- 按照功能模块将测试用例分解到不同的测试类中

### 3. 测试用例有效性
- 测试用例应当针对核心功能编写，而非仅仅满足覆盖率要求
- 避免无效充数的测试用例，确保每个测试都有实际意义
- 测试用例应覆盖正常情况、边界条件和异常情况

## 实施步骤

### 1. 识别大型测试类
- 查找包含大量测试方法的单个测试类（如UnitCoverageTest、OperatorTest）
- 分析其中的测试用例，识别它们实际测试的功能模块

### 2. 规划测试类结构
- 根据被测试代码的包结构规划新的测试类分布
- 为每个功能模块创建专门的测试类
- 确保测试类名称清晰反映其测试的内容

### 3. 迁移测试用例
- 将大型测试类中的测试用例逐一迁移到合适的测试类
- 维护测试用例的完整性，确保所有测试都被正确迁移
- 更新导入语句和依赖关系

### 4. 删除旧测试类
- 确认所有测试用例都已正确迁移后，删除原始的大型测试类
- 验证所有测试仍然可以通过

### 5. 覆盖率验证
- 运行JaCoCo覆盖率工具验证覆盖率变化
- 确保覆盖率达到预期目标（如80%）
- 识别覆盖率较低的区域并补充相应测试

## 实际案例

### 运算符测试重构

#### 原始结构
- 所有运算符测试集中在`OperatorTest.java`中

#### 重构后结构
- `com.kejin.expression.operator.calculate.MathOperatorTest.java` - 数学运算符测试
- `com.kejin.expression.operator.compare.CompareOperatorTest.java` - 比较运算符测试
- `com.kejin.expression.operator.method.MethodOperatorTest.java` - 方法运算符测试

#### 测试用例示例
```java
// MathOperatorTest.java
@Test
public void 加法() {
    TestUtil.execute("1+1", 2);
}

@Test
public void 加法编译失败() {
    TestUtil.compileFail("1+1+", "语法错误:[双目运算符缺少右边参数");
}
```

### 功能模块测试

#### 之前
- 所有功能测试集中在`UnitCoverageTest.java`

#### 之后
- `ExpressCompilerTest.java` - 表达式编译器测试
- `FastMapTest.java` - FastMap相关测试
- `DictionaryTest.java` - Dictionary相关测试
- `ExecuteExceptionTest.java` - 执行异常测试
- `ExpressionExceptionTest.java` - 表达式异常测试
- `BinaryExpressTest.java` - 二元表达式测试
- `MethodExpressTest.java` - 方法表达式测试
- `ValueTest.java` - 值相关测试
- `VarTest.java` - 变量相关测试
- `MapParamTest.java` - 参数映射测试
- `CollectionUtilsTest.java` - 集合工具测试
- `CaseExpressTest.java` - 条件表达式测试
- `BrokersExpressTest.java` - 括号表达式测试
- `DateUtilTest.java` - 日期工具测试
- `ExpressionCacheTest.java` - 表达式缓存测试
- `ErrorHandlingTest.java` - 错误处理测试

## 遇到的问题及解决方案

### 1. CollectionUtils.isNotEmpty方法调用歧义
- **问题**：方法有多个重载版本，编译器无法确定使用哪个版本
- **解决方案**：明确指定参数类型，例如 `(List<?>) null`、`(Map<?, ?>) null`、`(Object[]) null`

### 2. 导入错误
- **问题**：`Var`接口在`com.kejin.expression.var`包中，而不是其他包中
- **解决方案**：修正导入路径

### 3. 窗口函数实现错误
- **问题**：`GroupMaxMethod`和`GroupMinMethod`的比较逻辑错误
- **解决方案**：在测试中注释说明这些方法的实现错误

## 工具类优化

### TestUtil类改进
- 提供多种类型的`execute`方法以适应不同返回值类型
- 添加`compileFail`方法用于测试预期的编译失败情况
- 预定义参数映射以简化测试用例编写

## 测试用例组织策略

### 按功能模块组织
- 将相似功能的测试组织在一起
- 便于定位和维护
- 提高测试代码的可读性

### 按源代码结构组织
- 与源代码保持相同的包结构
- 便于查找对应的测试
- 遵循约定优于配置的原则

## 质量保证

### 重构前后验证
- 确保所有测试在重构后仍能通过
- 验证功能的正确性未受影响
- 检查覆盖率是否有所改善

### 持续改进
- 定期审查测试用例的有效性
- 移除冗余或无效的测试
- 添加缺失的重要测试场景

## 总结

通过将测试用例按照与源代码相同的包结构进行组织，我们实现了：
- 更好的代码可维护性
- 更高的测试覆盖率
- 更清晰的测试结构
- 更容易的故障定位